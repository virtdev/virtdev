#!/usr/bin/python

import zerorpc
import argparse

import sys
sys.path.append('..')

from lib.admin import create_user, get_password
from conf.virtdev import MASTER_ADDR, MASTER_PORT, AREA_CODE
from lib.util import USER_DOMAIN, DEVICE_DOMAIN, zmqaddr, server_list

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n', dest='username', default=None)
    parser.add_argument('-p', dest='password', default=None)
    parser.add_argument('-u', '--user', action='store_true')
    parser.add_argument('-d', '--device', action='store_true')
    parser.add_argument('-s', nargs='+', dest='server', default=None)
    parser.add_argument('-m', nargs='+', dest='mapper', default=None)
    parser.add_argument('-f', nargs='+', dest='finder', default=None)
    parser.add_argument('-a', nargs='+', dest='areacode', default=None)
    
    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit()
    
    args = parser.parse_args(sys.argv[1:])
    username = args.username
    password = args.password
    areacode = args.areacode
    
    if args.user:
        domain = USER_DOMAIN
    elif args.device:
        domain = DEVICE_DOMAIN
    else:
        domain = None
    
    if args.finder or args.mapper or args.server:
        if not domain:
            print('Error: no domain')
            sys.exit()
        
        if args.server:
            if areacode:
                if len(areacode) != len(args.server):
                    print('Error: invalid area code')
                    sys.exit()
                for i in range(len(args.server)):
                    areacode[i] = int(areacode[i])
            else:
                areacode = [AREA_CODE] * len(args.server)
        
        c = zerorpc.Client()
        c.connect(zmqaddr(MASTER_ADDR, MASTER_PORT))
        try:
            if args.server:
                c.add_servers(domain, server_list(args.server, areacode))
            elif args.finder:
                c.add_finders(domain, args.finder)
            elif args.mapper:
                c.add_mappers(domain, args.mapper)
        finally:
            c.close()
    
    if username and password:
        create_user(username, password)
    elif username:
        print(get_password(username))
